================================================================================
MARKET POSITION LOGIC IMPLEMENTATION - QUICK REFERENCE
================================================================================

OVERVIEW:
The Grid Scalper bot now integrates with Volatility_Detector_Crypto to open/close
market positions based on trend and momentum analysis. This runs independently from
the grid trading logic.

================================================================================
FILES MODIFIED/CREATED:
================================================================================

1. Volatility_Detector_Crypto/src/bot/analyze_ticker.py
   - Added JSON output format with --json flag
   - Extracts trend and momentum from analysis
   - Command: python -m src.bot.analyze_ticker BTCUSDT --json

2. crypto_grid_scalper (stable trends)/src/config.py
   - Added 4 new configuration variables:
     * enableMarketPositionLogic (default: True)
     * analysisIntervalMinutes (default: 10)
     * volatilityDetectorMaxRetries (default: 3)
     * volatilityDetectorPath (default: ../Volatility_Detector_Crypto)

3. crypto_grid_scalper (stable trends)/.env
   - Added new environment variables for market position logic

4. crypto_grid_scalper (stable trends)/src/market_position_manager.py (NEW)
   - Main module for market position management
   - Runs Volatility Detector analysis every N minutes
   - Opens/closes positions based on trend/momentum
   - Handles TP/SL for market positions
   - Implements retry logic with max 3 attempts

5. crypto_grid_scalper (stable trends)/src/bot.py
   - Integrated MarketPositionManager
   - Added market position TP/SL checks in run() loop
   - Added market position analysis call at end of run()

================================================================================
CONFIGURATION (.env):
================================================================================

ENABLE_MARKET_POSITION_LOGIC="True"
  - Enable/disable the market position logic feature

ANALYSIS_INTERVAL_MINUTES=10
  - How often to run Volatility Detector analysis (in minutes)

VOLATILITY_DETECTOR_MAX_RETRIES=3
  - Maximum retry attempts if analysis fails

VOLATILITY_DETECTOR_PATH="../Volatility_Detector_Crypto"
  - Path to Volatility Detector directory

================================================================================
LOGIC FLOW:
================================================================================

Every 10 minutes (configurable):
  1. Run: python -m src.bot.analyze_ticker {SYMBOL} --json
  2. Parse output to get Trend and Momentum
  3. Compare with previous result (if same, continue current trade)
  4. Determine action based on conditions:

     Condition 1: UPTREND + OVERBOUGHT
     → Close any existing market position
     → Open LONG market position at current price
     → Set TP/SL targets

     Condition 2: DOWNTREND + OVERSOLD
     → Close any existing market position
     → Open SHORT market position at current price
     → Set TP/SL targets

     Condition 3: NEUTRAL momentum
     → Close current market position (if any)
     → Do NOT open new position

     Condition 4: Same as previous result
     → Continue current trade (no action)

Every bot cycle (10 seconds):
  1. Check market position TP/SL targets
  2. Close position if TP or SL triggered
  3. Continue grid trading logic (unchanged)
  4. Run market position analysis (if interval elapsed)

================================================================================
POSITION TYPES:
================================================================================

GRID POSITIONS (existing):
  - Opened by grid limit orders
  - Closed by: TP/SL, Stop Loss, Take Profit, 75% Range Rule, 3-Position Rule
  - NOT affected by NEUTRAL momentum signal

MARKET POSITIONS (new):
  - Opened by market order based on Volatility Detector signal
  - Closed by: TP/SL, Stop Loss, Take Profit, 75% Range Rule, NEUTRAL momentum
  - Only ONE market position at a time (LONG or SHORT)
  - Uses same leverage, position size, and TP/SL percentages as grid

================================================================================
ERROR HANDLING:
================================================================================

If Volatility Detector analysis fails:
  1. Retry up to 3 times (configurable)
  2. Wait 5 seconds between retries
  3. If all retries fail, skip this session
  4. Try again in 10 minutes (next analysis interval)
  5. Log all errors for debugging

================================================================================
TESTING:
================================================================================

Run the test script to verify integration:
  python test_market_position_integration.py

This tests:
  1. Config loading with new variables
  2. MarketPositionManager import
  3. Volatility Detector JSON output format

================================================================================
EXAMPLE WORKFLOW:
================================================================================

Time: 10:00 AM
  - Bot starts, grid trading begins
  - Market position manager initialized

Time: 10:10 AM (first analysis)
  - Run: python -m src.bot.analyze_ticker BTCUSDT --json
  - Output: {"trend": "UPTREND", "momentum": "OVERBOUGHT", ...}
  - Action: Open LONG market position at current price
  - Set TP/SL targets

Time: 10:15 AM
  - Check market position TP/SL
  - Grid trading continues independently

Time: 10:20 AM (second analysis)
  - Run: python -m src.bot.analyze_ticker BTCUSDT --json
  - Output: {"trend": "UPTREND", "momentum": "OVERBOUGHT", ...}
  - Same as previous → Continue LONG position (no action)

Time: 10:30 AM (third analysis)
  - Run: python -m src.bot.analyze_ticker BTCUSDT --json
  - Output: {"trend": "UPTREND", "momentum": "NEUTRAL", ...}
  - Action: Close LONG market position
  - Wait for next signal

================================================================================
KEY FEATURES:
================================================================================

✓ Separate from grid trading (independent logic)
✓ Configurable analysis interval (default 10 minutes)
✓ Automatic retry on failure (max 3 attempts)
✓ Same TP/SL as grid positions
✓ Only one market position at a time
✓ Prevents duplicate trades (compares with previous result)
✓ Comprehensive logging
✓ Uses Decimal precision for calculations
✓ Respects leverage setting from .env

================================================================================
TROUBLESHOOTING:
================================================================================

Issue: "Volatility Detector analysis failed after 3 retries"
  → Check if Volatility_Detector_Crypto path is correct in .env
  → Verify BTCUSDT (or your symbol) is available in Volatility Detector
  → Check internet connection

Issue: Market position not opening
  → Check if ENABLE_MARKET_POSITION_LOGIC=True in .env
  → Verify Volatility Detector is returning valid trend/momentum
  → Check API credentials and balance

Issue: Market position not closing on NEUTRAL
  → Verify momentum is actually NEUTRAL (not OVERBOUGHT/OVERSOLD)
  → Check bot logs for analysis results

Issue: "No matching condition"
  → This is normal - means trend/momentum combination doesn't match any condition
  → Bot will wait for next analysis cycle

================================================================================
